 

# 1    JWT 讲解

上面我们基本测试了一下Rest API的实现。但是没有使用rest接口的鉴权。

在实际开发过程中，rest风格的api也需要访问控制，并不是任意访问就可以去往数据库里插入东西的。所以我们需要JWT来做访问控制。

## 1.1  认识

JSON Web Token (JWT)是一个开放标准(RFC 7519)，它定义了一种紧凑的、自包含的方式，用于作为JSON对象在各方之间安全地传输信息。该信息可以被验证和信任，因为它是数字签名的。

 

## 1.2  使用场景

下列场景中使用JSON Web Token是很有用的：

* Authorization (授权) : 这是使用JWT的最常见场景。一旦用户登录，后续每个请求都将包含JWT，允许用户访问该令牌允许的路由、服务和资源。单点登录是现在广泛使用的JWT的一个特性，因为它的开销很小，并且可以轻松地跨域使用。

* Information Exchange (信息交换) : 对于安全的在各方之间传输信息而言，JSON Web Tokens无疑是一种很好的方式。因为JWTs可以被签名，例如，用公钥/私钥对，你可以确定发送人就是它们所说的那个人。另外，由于签名是使用头和有效负载计算的，您还可以验证内容有没有被篡改

 

## 1.3  为啥要用JWT？

##### 1.3.1.1.1     跨域访问问题

比如你网站有几个不同的后台的域名，

a：m.Taobao.com

b：xxx.taobao.com

你在a域名下登录，登录信息记录到cookie，那么后面只有访问a域名才会带cookie，其他域名是不会带cookie的。

那么怎么办？

这就是跨域请求问题。

##### 1.3.1.1.2     单点登录的问题

在集群的场景下，为了解决识别登录用户的问题，有两个传统的解决方案。

方案1：nginx负载均衡做iphash，同一个用户的请求永远给到同一个后台服务器。

方案2：session复制。

这两种方案实际上都不好。

那么如何优化呢？我们来使用token解决这个问题。

## 1.4  Token vs Session

基于Token的身份认证 与 基于服务器的身份认证

### 1.4.1 Session

在讨论基于Token的身份认证是如何工作的以及它的好处之前，我们先来看一下以前我们是怎么做的：（基于session的身份认证）

HTTP协议是无状态的，也就是说，如果我们已经认证了一个用户，那么他下一次请求的时候，服务器不知道我是谁，我们必须再次认证

传统的做法是将已经认证过的用户信息存储在服务器上，比如Session。用户下次请求的时候带着Session ID，然后服务器以此检查用户是否认证过。

这种基于服务器的身份认证方式存在一些问题：

* Sessions : 每次用户认证通过以后，服务器需要创建一条记录保存用户信息，通常是在内存中，随着认证通过的用户越来越多，服务器的在这里的开销就会越来越大。

* Scalability : 由于Session是在内存中的，这就带来一些扩展性的问题。

* CORS : 当我们想要扩展我们的应用，让我们的数据被多个移动设备使用时，我们必须考虑跨资源共享问题。当使用AJAX调用从另一个域名下获取资源时，我们可能会遇到禁止请求的问题。

* CSRF : 用户很容易受到CSRF攻击

 

### 1.4.2 Token

基于token的身份认证其具体做法是这样的：

使用基于 Token 的身份验证方法，在服务端不需要存储用户的登录记录，大概流程如下：

　　1. 客户端使用用户名、密码请求登录

　　2. 服务端收到请求、去验证用户名与密码

　　3. 验证成功后，服务端会签发一个 token ，再把这个 token 发送给客户端

　　4. 客户端收到 token 以后可以把它存储起来，存到客户端内存或者其他地方。 

　　5. 客户端每次向服务器请求资源的时候需要带着服务器签发的 token

　　6. 服务端收到请求，然后去验证客户端请求里面带着的 token，如果验证成功，就向客户端返回请求的数据。

相同点是，它们都是存储用户信息；然而，Session是在服务器端的，而JWT是在客户端的。

Session方式存储用户信息的最大问题在于要占用大量服务器内存，增加服务器的开销。

而token的方式将用户状态分散到了客户端中，可以明显减轻服务端的内存压力。

Session的状态是存储在服务器端，客户端只有session id；而Token的状态是存储在客户端。

![img](https://typora-1301192342.cos.ap-guangzhou.myqcloud.com/img/20200527211850.jpg)

![img](https://typora-1301192342.cos.ap-guangzhou.myqcloud.com/img/20200527211905.jpg)

基于Token的身份认证是无状态的，服务器或者Session中不会存储任何用户信息。没有会话信息意味着应用程序可以根据需要扩展和添加更多的机器，而不必担心用户登录的位置。

虽然这一实现可能会有所不同，但其主要流程如下：

1. 用户携带用户名和密码请求访问

2. 服务器校验用户凭据

3. 应用提供一个token给客户端

4. 客户端存储token，并且在随后的每一次请求中都带着它

5. 服务器校验token并返回数据

注意：

1. 每一次请求都需要token

2. Token应该放在请求header中

3. 我们还需要将服务器设置为接受来自所有域的请求，用`Access-Control-Allow-Origin：*`

### 1.4.3 用Token的好处

* 无状态和可扩展性：Tokens存储在客户端。完全无状态，可扩展。我们的负载均衡器可以将用户传递到任意服务器，因为在任何地方都没有状态或会话信息。

* 安全：Token不是Cookie。（The token, not a cookie.）每次请求的时候Token都会被发送。而且，由于没有Cookie被发送，还有助于防止CSRF攻击。即使在你的实现中将token存储到客户端的Cookie中，这个Cookie也只是一种存储机制，而非身份认证机制。没有基于会话的信息可以操作，因为我们没有会话!

## 1.5   JWT token的基本格式

JSON Web Token的结构是什么样的

JSON Web Token由三部分组成，它们之间用圆点(.)连接。这三部分分别是：

* Header

* Payload

* Signature

因此，一个典型的JWT看起来是这个样子的：

`xxxxx.yyyyy.zzzzz`

![img](https://typora-1301192342.cos.ap-guangzhou.myqcloud.com/img/20200527212432.jpg)

具体如下图：

![img](https://typora-1301192342.cos.ap-guangzhou.myqcloud.com/img/20200527212453.jpg)